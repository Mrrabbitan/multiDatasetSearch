# LanceDB è¿ç§»æŒ‡å—

## ðŸ“‹ æ”¹é€ å†…å®¹

å·²å°†å‘é‡å­˜å‚¨ä»Ž **FAISS + NumPy + SQLite** è¿ç§»åˆ° **LanceDB**ï¼Œå®žçŽ°å‘é‡å’Œå…ƒæ•°æ®ä¸€ä½“åŒ–å­˜å‚¨ã€‚

### ä¸»è¦å˜æ›´

1. **é…ç½®æ–‡ä»¶** (`poc/config/poc.yaml`)
   - ç§»é™¤: `embeddings_dir`, `index_dir`
   - æ–°å¢ž: `lancedb_dir: "poc/data/lancedb"`

2. **å‘é‡ç”Ÿæˆ** (`poc/pipeline/embed.py`)
   - ç›´æŽ¥å°†å‘é‡å’Œå…ƒæ•°æ®å†™å…¥ LanceDB
   - è‡ªåŠ¨åˆ›å»ºå‘é‡ç´¢å¼•ï¼ˆcosine ç›¸ä¼¼åº¦ï¼‰
   - ä¸å†éœ€è¦å•ç‹¬çš„ NumPy æ–‡ä»¶

3. **æ£€ç´¢æŸ¥è¯¢** (`poc/search/query.py`)
   - ä½¿ç”¨ LanceDB çš„å‘é‡æœç´¢ API
   - æ”¯æŒæ··åˆæŸ¥è¯¢ï¼ˆå‘é‡ + å±žæ€§è¿‡æ»¤ï¼‰
   - ç®€åŒ–äº†ä»£ç é€»è¾‘

4. **Web ç•Œé¢** (`poc/app/app_v2.py`)
   - æ›´æ–°ä¸ºä½¿ç”¨ LanceDB
   - ç§»é™¤ FAISS ç›¸å…³ä»£ç 

5. **è„šæœ¬æ›´æ–°** (`é‡æ–°å…¥åº“.sh`)
   - ç§»é™¤ç´¢å¼•æž„å»ºæ­¥éª¤ï¼ˆä¸å†éœ€è¦ï¼‰
   - ç®€åŒ–ä¸º 3 æ­¥ï¼šæ¸…ç† â†’ å¯¼å…¥ â†’ ç”Ÿæˆå‘é‡

6. **åˆ é™¤æ–‡ä»¶**
   - `poc/search/index.py` - ä¸å†éœ€è¦å•ç‹¬å»ºç´¢å¼•

## ðŸš€ å®‰è£…ä¾èµ–

åœ¨ multimodal çŽ¯å¢ƒä¸­å®‰è£… LanceDBï¼š

```bash
conda activate multimodal
pip install lancedb
```

## ðŸ“¦ ä½¿ç”¨æ–¹æ³•

### 1. é‡æ–°ç”Ÿæˆæ•°æ®

```bash
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
bash é‡æ–°å…¥åº“.sh
```

è¿™ä¼šï¼š
- æ¸…ç†æ—§çš„ FAISS ç´¢å¼•å’Œ NumPy æ–‡ä»¶
- é‡æ–°å¯¼å…¥ç»“æž„åŒ–æ•°æ®
- ç”Ÿæˆå‘é‡å¹¶å†™å…¥ LanceDBï¼ˆåŒ…å«å…ƒæ•°æ®ï¼‰

### 2. å¯åŠ¨æœåŠ¡

```bash
bash restart_poc.sh
```

## âœ¨ LanceDB ä¼˜åŠ¿

### ç›¸æ¯” FAISS æ–¹æ¡ˆçš„æ”¹è¿›ï¼š

| ç‰¹æ€§ | FAISS æ–¹æ¡ˆ | LanceDB æ–¹æ¡ˆ |
|------|-----------|-------------|
| å­˜å‚¨æ–¹å¼ | å‘é‡å’Œå…ƒæ•°æ®åˆ†ç¦» | ä¸€ä½“åŒ–å­˜å‚¨ |
| æ›´æ–°æ–¹å¼ | éœ€è¦é‡å»ºæ•´ä¸ªç´¢å¼• | æ”¯æŒå¢žé‡æ›´æ–° |
| æŸ¥è¯¢æ–¹å¼ | ä¸¤æ­¥æŸ¥è¯¢ï¼ˆå‘é‡â†’å…ƒæ•°æ®ï¼‰ | ä¸€æ­¥å®Œæˆ |
| è¿‡æ»¤åŠŸèƒ½ | åŽç½®è¿‡æ»¤ï¼ˆä½Žæ•ˆï¼‰ | å†…ç½®æ··åˆæŸ¥è¯¢ |
| ä»£ç å¤æ‚åº¦ | é«˜ï¼ˆ3ä¸ªå­˜å‚¨ç³»ç»Ÿï¼‰ | ä½Žï¼ˆ1ä¸ªç³»ç»Ÿï¼‰ |
| æ€§èƒ½ | å¥½ | æ›´å¥½ï¼ˆé›¶æ‹·è´ï¼‰ |

### å…·ä½“æ”¹è¿›ï¼š

1. **ç®€åŒ–æž¶æž„**
   ```
   æ—§: CSV â†’ SQLite â†’ embed.py â†’ NumPy â†’ index.py â†’ FAISS â†’ query.py
   æ–°: CSV â†’ SQLite â†’ embed.py â†’ LanceDB â†’ query.py
   ```

2. **æ”¯æŒå¢žé‡æ›´æ–°**
   - æ·»åŠ æ–°å›¾ç‰‡ä¸éœ€è¦é‡å»ºæ•´ä¸ªç´¢å¼•
   - å¯ä»¥ç›´æŽ¥ append åˆ° LanceDB

3. **æ›´é«˜æ•ˆçš„è¿‡æ»¤**
   - å‘é‡æœç´¢å’Œå±žæ€§è¿‡æ»¤åœ¨æ•°æ®åº“å±‚é¢å®Œæˆ
   - å‡å°‘æ•°æ®ä¼ è¾“å’Œå†…å­˜å ç”¨

4. **æ›´å¥½çš„å¯ç»´æŠ¤æ€§**
   - ä¸éœ€è¦ç»´æŠ¤ `index_meta.json`
   - ä¸éœ€è¦åŒæ­¥å¤šä¸ªå­˜å‚¨ç³»ç»Ÿ

## ðŸ”§ æŠ€æœ¯ç»†èŠ‚

### LanceDB è¡¨ç»“æž„

```python
{
    "asset_id": str,           # èµ„äº§ID
    "file_path": str,          # æ–‡ä»¶è·¯å¾„
    "file_name": str,          # æ–‡ä»¶å
    "captured_at": str,        # æ‹æ‘„æ—¶é—´
    "lat": float,              # çº¬åº¦
    "lon": float,              # ç»åº¦
    "event_type": str,         # äº‹ä»¶ç±»åž‹
    "alarm_time": str,         # å‘Šè­¦æ—¶é—´
    "alarm_level": str,        # å‘Šè­¦çº§åˆ«
    "model_name": str,         # æ¨¡åž‹åç§°
    "vector": List[float],     # å‘é‡ï¼ˆ768ç»´ï¼‰
}
```

### å‘é‡ç´¢å¼•é…ç½®

```python
table.create_index(
    metric="cosine",        # ä½™å¼¦ç›¸ä¼¼åº¦
    num_partitions=256,     # åˆ†åŒºæ•°
    num_sub_vectors=96      # å­å‘é‡æ•°
)
```

### æ··åˆæŸ¥è¯¢ç¤ºä¾‹

```python
# å‘é‡æœç´¢ + å±žæ€§è¿‡æ»¤
query = table.search(query_vec) \
    .where("event_type = 'ç«ç¾' AND lat >= 30.0 AND lat <= 40.0") \
    .limit(10)
```

## ðŸ“ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡Œéœ€è¦é‡æ–°ç”Ÿæˆæ•°æ®**
   - æ—§çš„ FAISS ç´¢å¼•ä¸å…¼å®¹
   - è¿è¡Œ `bash é‡æ–°å…¥åº“.sh` å³å¯

2. **LanceDB æ•°æ®ç›®å½•**
   - ä½ç½®: `poc/data/lancedb/`
   - åŒ…å«è¡¨æ•°æ®å’Œç´¢å¼•æ–‡ä»¶
   - å¯ä»¥ç›´æŽ¥å¤‡ä»½æ•´ä¸ªç›®å½•

3. **æ€§èƒ½ä¼˜åŒ–**
   - å‘é‡ç´¢å¼•å·²è‡ªåŠ¨åˆ›å»º
   - é€‚åˆ 10ä¸‡+ çº§åˆ«çš„æ•°æ®é‡
   - å¦‚æžœæ•°æ®é‡æ›´å¤§ï¼Œå¯ä»¥è°ƒæ•´ `num_partitions`

## ðŸ› æ•…éšœæŽ’æŸ¥

### é—®é¢˜1: ModuleNotFoundError: No module named 'lancedb'

```bash
conda activate multimodal
pip install lancedb
```

### é—®é¢˜2: è¡¨ä¸å­˜åœ¨

```bash
# é‡æ–°ç”Ÿæˆæ•°æ®
bash é‡æ–°å…¥åº“.sh
```

### é—®é¢˜3: ç»´åº¦ä¸åŒ¹é…

ç¡®ä¿é…ç½®æ–‡ä»¶ä¸­çš„æ¨¡åž‹åç§°æ­£ç¡®ï¼š
```yaml
search:
  clip_model: "clip-ViT-L-14"  # 768ç»´
```

## ðŸ“š å‚è€ƒèµ„æ–™

- [LanceDB å®˜æ–¹æ–‡æ¡£](https://lancedb.github.io/lancedb/)
- [LanceDB Python API](https://lancedb.github.io/lancedb/python/)
- [Apache Arrow](https://arrow.apache.org/)
